#!/bin/bash

if ! command -v opencode &> /dev/null; then
    echo "Warning: 'opencode' command not found, skipping service"
    exit 0
fi

ACTION="start"

for arg in "$@"; do
    case "$arg" in
        --stop)
            ACTION="stop"
            ;;
        --start)
            ACTION="start"
            ;;
        *)
            echo "Unknown argument: $arg"
            exit 1
            ;;
    esac
done

detect_os() {
    case "$(uname -s)" in
        Linux*)     echo "linux" ;;
        Darwin*)    echo "macos" ;;
        CYGWIN*|MINGW*|MSYS*) echo "windows" ;;
        *)          echo "unknown" ;;
    esac
}

handle_linux() {
    if [ -f "$SCRIPT_DIR/opencode-systemd.sh" ]; then
        bash "$SCRIPT_DIR/opencode-systemd.sh" $ACTION
    else
        echo "Error: opencode-systemd.sh not found"
        exit 1
    fi
}

handle_windows() {
    if [ -f "$SCRIPT_DIR/opencode-windows.ps1" ]; then
        powershell -ExecutionPolicy Bypass -File "$SCRIPT_DIR/opencode-windows.ps1" $ACTION
    else
        echo "Error: opencode-windows.ps1 not found"
        exit 1
    fi
}

OS=$(detect_os)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

case "$OS" in
    linux)
        handle_linux
        ;;
    windows)
        handle_windows
        ;;
    *)
        echo "opencode service not enabled on $OS"
        ;;
esac
